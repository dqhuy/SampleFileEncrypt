@using System.Text.Json
@{

	Layout = "~/Views/Shared/_Layout.cshtml";
}
@model PDFManagementApp.Models.Document
<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-4 text-blue-600 flex items-center gap-2">
        <i class="fas fa-file-pdf"></i>
        Xem tài liệu: @Model.FileName
    </h2>

    @if (ViewBag.Error != null)
    {
        <div class="text-red-500 bg-red-100 p-2 rounded mb-4 flex items-center gap-2">
            <i class="fas fa-exclamation-triangle"></i>
            @ViewBag.Error
        </div>
    }

    <form method="post" action="/Document/View/@Model.Id" class="flex flex-col gap-4 mb-4">
        <div>
            <input type="hidden" name="encryptionKey" value="@ViewBag.EncryptionKey"
                   class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 transition" />
        </div>
        <button type="submit"
                class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded shadow transition duration-300 ease-in-out">
            <i class="fas fa-eye"></i>
            Xem preview PDF
        </button>
    </form>

    <form method="post" action="/Document/ViewNative/@Model.Id" class="flex flex-col gap-4 mb-4">
        <div>
            <input type="hidden" name="encryptionKey" value="@ViewBag.EncryptionKey"
                   class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 transition" />
        </div>
        <button type="submit"
                class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded shadow transition duration-300 ease-in-out">
            <i class="fas fa-eye"></i>
            Xem chi tiết file PDF
        </button>
    </form>

    <!-- Khung hiển thị PDF -->
    <div id="pdf-viewer" class="border rounded shadow overflow-auto" style="height: 500px;">
        <canvas id="pdf-canvas" class="w-full"></canvas>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>

<script>
    const base64Pdf = @Html.Raw(JsonSerializer.Serialize(ViewBag.PdfBase64 ?? ""));
    console.log("Base64 length:", base64Pdf.length);

    function base64ToUint8Array(base64) {
        const raw = window.atob(base64);
        const rawLength = raw.length;
        const array = new Uint8Array(rawLength);
        for (let i = 0; i < rawLength; i++) {
            array[i] = raw.charCodeAt(i);
        }
        return array;
    }

    if (base64Pdf) {
        const pdfData = base64ToUint8Array(base64Pdf);

        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');

        pdfjsLib.getDocument({ data: pdfData }).promise.then(function(pdfDoc_) {
            pdfDoc_.getPage(1).then(function(page) {
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext);
            });
        }).catch(function(error) {
            console.error('Error loading PDF: ', error);
        });
    }
</script>


